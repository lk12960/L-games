<!-- Popup HTML -->
<div id="welcome-popup" class="popup-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="popup-title" aria-hidden="true">
  <div class="popup-content">
    <h2 id="popup-title"></h2>
    <p id="popup-body"></p>
    <div style="display:flex; gap:12px; justify-content:center;">
      <button onclick="closePopup()" class="close-btn">Close</button>
      <button onclick="dontShowAgain()" class="close-btn">Ok, donâ€™t show again</button>
    </div>
  </div>
</div>

<!-- Popup Styles -->
<style>
  .popup-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  .popup-content {
    background-color: #444;
    color: white;
    border: 2px solid white;
    padding: 30px 40px;
    text-align: center;
    border-radius: 10px;
    width: 450px;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.3);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .popup-content h2 { margin-bottom: 15px; }
  .popup-content p { line-height: 1.5; font-size: 1.1rem; }
  .close-btn {
    margin-top: 25px;
    padding: 10px 25px;
    background-color: #444;
    color: white;
    border: 2px solid white;
    cursor: pointer;
    font-size: 1rem;
    border-radius: 5px;
    transition: all 0.3s ease;
    font-weight: 600;
  }
  .close-btn:hover {
    background-color: white;
    color: #444;
    border-color: #444;
  }
</style>

<!-- Master Script Wrapper -->
<script>
(function safeRunner(){
  try {
    // --- Configurable Constants ---
    const DISMISS_KEY = "dismissed_popup_version";
    const PANTRY_ID = 'cdb7692f-15c1-46b5-ae67-f13af0746cc8';

    // Fetch data from Pantry
    async function fetchFromPantry(basket) {
      try {
        const res = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${basket}`);
        console.log(`Fetching ${basket}: Status ${res.status}`);
        if (!res.ok) throw new Error(`Failed to fetch ${basket}: ${res.statusText}`);
        return await res.json();
      } catch (err) {
        console.error(`Error fetching ${basket}:`, err);
        return {};
      }
    }

    // Escape text to prevent XSS
    function escapeText(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Convert newlines to <br> for content
    function formatContent(text) {
      return escapeText(text).replace(/\n/g, '<br>');
    }

    // Close (temporary hide)
    function closePopup() {
      try {
        const el = document.getElementById("welcome-popup");
        if (!el) return;
        el.style.display = "none";
        el.setAttribute("aria-hidden", "true");
      } catch(e){ console.error("Popup close error", e); }
    }
    window.closePopup = closePopup;

    // Don't show again (persist dismissal)
    function dontShowAgain() {
      try {
        const popupVersion = window.POPUP_VERSION || "2025-09-14"; // Fallback
        localStorage.setItem(DISMISS_KEY, popupVersion);
        closePopup();
      } catch(e){ console.error("DontShowAgain error", e); }
    }
    window.dontShowAgain = dontShowAgain;

    // --- Fetch and Apply Config on Load ---
    window.addEventListener("load", async function(){
      try {
        const data = await fetchFromPantry('config');
        // Set global versions from config
        window.SITE_VERSION = data.site_version || "6.6"; // Fallback
        window.POPUP_VERSION = data.popup_version || "2025-09-14"; // Fallback

        // Auth Check: Preserve user_authenticated and user_email
        const currentSiteVersion = localStorage.getItem("site_version");
        const userAuthenticated = localStorage.getItem("user_authenticated");
        const userEmail = localStorage.getItem("user_email");
        if (currentSiteVersion !== window.SITE_VERSION) {
          // Clear non-authentication data
          for (let key in localStorage) {
            if (key !== "user_authenticated" && key !== "user_email" && key !== "site_version") {
              localStorage.removeItem(key);
            }
          }
          localStorage.setItem("site_version", window.SITE_VERSION);
          console.log(`Site version updated to ${window.SITE_VERSION}`);
        }

        // Verify user is authenticated and whitelisted
        if (userAuthenticated !== "true" || !userEmail) {
          console.log("User not authenticated, redirecting to signin.html");
          window.location.href = "https://cool-math-worksheets-1.s3.us-east-1.amazonaws.com/signin.html";
          return;
        }

        const whitelistData = await fetchFromPantry('whitelist');
        const whitelistedEmails = whitelistData.whitelisted_emails || [];
        if (!whitelistedEmails.includes(userEmail)) {
          console.log(`User email ${userEmail} not in whitelist, redirecting to signin.html`);
          localStorage.clear();
          window.location.href = "https://cool-math-worksheets-1.s3.us-east-1.amazonaws.com/signin.html";
          return;
        }

        // Global Redirect
        if (data.redirect_url && window.location.pathname !== '/signin.html') {
          console.log(`Redirecting to ${data.redirect_url}`);
          window.location.href = data.redirect_url;
          return;
        }

        // Chatbot Disable
        if (data.disable_chatbot) {
          const chatButton = document.getElementById('chatButton');
          const chatWindow = document.getElementById('chatWindow');
          if (chatButton) chatButton.style.display = 'none';
          if (chatWindow) chatWindow.style.display = 'none';
        }

        // Popup Handling
        if (data.popup_enabled !== false && data.popup_title && data.popup_content) {
          const dismissed = localStorage.getItem(DISMISS_KEY);
          if (dismissed !== window.POPUP_VERSION) {
            const el = document.getElementById("welcome-popup");
            if (!el) return;

            const popupTitle = document.getElementById('popup-title');
            const popupBody = document.getElementById('popup-body');
            if (popupTitle) popupTitle.innerHTML = escapeText(data.popup_title);
            if (popupBody) popupBody.innerHTML = formatContent(data.popup_content);

            el.style.display = "flex";
            el.setAttribute("aria-hidden", "false");
            const btn = el.querySelector("button");
            if (btn) btn.focus();
          }
        }
      } catch(err) {
        console.error("Error loading config from Pantry:", err);
        // Fallback to defaults
        window.SITE_VERSION = "6.6";
        window.POPUP_VERSION = "2025-09-14";
      }
    });

    // --- Panic Key ---
    window.addEventListener("keydown", function(e){
      try {
        if (e.key === "`" || e.key === "~" || e.code === "Backquote") {
          console.log("Panic key pressed, redirecting to Clever");
          window.location.href = "https://clever.com/oauth/saml/login?target=NWU4M2IwYzI2YTBkOTIwMDAxZjE4YzY3;NGM2M2MxY2Y2MjNkY2U4MmNhYWM=;aHR0cHM6Ly9jbGV2ZXIuY29tL2luL2F1dGhfY2FsbGJhY2s=;OGNkZjY5ZjdlZTNhMjQ1ZGYyMzhiMGFkMDhiYTA4N2MzOWZkMDg1ZTRkM2VmOTQwY2M3NDQyNzI2ZjkxOWNjZg==;Y29kZQ==";
        }
      } catch(err){ console.error("Panic key error", err); }
    });

    // --- Google Analytics ---
    try {
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-ELC1SXB08M');
    } catch(e){ console.error("GA error", e); }

  } catch(e) {
    console.error("Fatal script error", e);
  }
})();
</script>

<!-- Google Analytics Loader -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ELC1SXB08M"></script>