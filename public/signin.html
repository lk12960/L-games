<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cool Math Worksheets Teacher Sign-In</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      background-color: white;
      color: black;
      text-align: center;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    h1 {
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 20px;
    }

    .signin-container {
      margin-top: 100px;
    }

    .math-symbols {
      font-size: 50px;
      position: absolute;
      opacity: 0.2;
    }

    .symbol1 {
      top: 10%;
      left: 10%;
      transform: rotate(-15deg);
    }

    .symbol2 {
      top: 80%;
      left: 20%;
      transform: rotate(10deg);
    }

    .symbol3 {
      top: 40%;
      right: 15%;
      transform: rotate(-30deg);
    }

    .symbol4 {
      bottom: 10%;
      right: 5%;
      transform: rotate(20deg);
    }
  </style>
</head>

<body>
  <h1>Cool Math Worksheets Secret Sign-In</h1>

  <div class="math-symbols symbol1">➗</div>
  <div class="math-symbols symbol2">➕</div>
  <div class="math-symbols symbol3">✖️</div>
  <div class="math-symbols symbol4">➖</div>

  <!-- Google Sign-In button container -->
  <div class="signin-container" id="signin-button"></div>

  <script>
    let WHITELISTED_EMAILS = [];

    async function fetchWhitelistedEmails() {
      try {
        const response = await fetch('authorized.html');
        const text = await response.text();
        WHITELISTED_EMAILS = text
          .split('\n')
          .map(email => email.trim())
          .filter(email => email);
        console.log("Whitelist loaded:", WHITELISTED_EMAILS);

        // Only initialize sign-in after whitelist is loaded
        initializeGoogleSignIn();
      } catch (error) {
        console.error('Error loading authorized emails:', error);
        alert("Could not load authorized user list.");
      }
    }

    function initializeGoogleSignIn() {
      google.accounts.id.initialize({
        client_id: "273294914895-5vhe9qupotv9ldtd03jjauhr85oed0g5",
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById("signin-button"),
        { theme: "outline", size: "large" }
      );
    }

    async function handleCredentialResponse(response) {
      try {
        const token = response.credential;
        const res = await fetch('https://oauth2.googleapis.com/tokeninfo?id_token=' + token);
        const data = await res.json();
        const email = data.email;

        console.log("Signed in as:", email);

        if (WHITELISTED_EMAILS.includes(email)) {
          localStorage.setItem("user_authenticated", "true");
          window.location.href = "https://cool-math-worksheets.s3.us-east-2.amazonaws.com/worksheets.html";
        } else {
          alert("Access denied: " + email + " is not on the authorized list.");
          localStorage.removeItem("user_authenticated");
        }
      } catch (err) {
        console.error("Error during sign-in:", err);
        alert("An error occurred during sign-in.");
      }
    }

    fetchWhitelistedEmails(); // Start by loading whitelist
  </script>
</body>

</html>
